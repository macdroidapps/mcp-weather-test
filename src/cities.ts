/**
 * База данных координат городов
 * Расширьте этот список по мере необходимости
 */

import type { CityCoordinates } from './types.js';

// Словарь городов с координатами
const CITIES: Record<string, CityCoordinates> = {
  // Россия
  'москва': { lat: 55.7558, lon: 37.6173, name: 'Москва' },
  'санкт-петербург': { lat: 59.9343, lon: 30.3351, name: 'Санкт-Петербург' },
  'петербург': { lat: 59.9343, lon: 30.3351, name: 'Санкт-Петербург' },
  'спб': { lat: 59.9343, lon: 30.3351, name: 'Санкт-Петербург' },
  'новосибирск': { lat: 55.0084, lon: 82.9357, name: 'Новосибирск' },
  'екатеринбург': { lat: 56.8389, lon: 60.6057, name: 'Екатеринбург' },
  'казань': { lat: 55.8304, lon: 49.0661, name: 'Казань' },
  'нижний новгород': { lat: 56.2965, lon: 43.9361, name: 'Нижний Новгород' },
  'челябинск': { lat: 55.1644, lon: 61.4368, name: 'Челябинск' },
  'самара': { lat: 53.1959, lon: 50.1002, name: 'Самара' },
  'омск': { lat: 54.9885, lon: 73.3242, name: 'Омск' },
  'ростов-на-дону': { lat: 47.2357, lon: 39.7015, name: 'Ростов-на-Дону' },
  'уфа': { lat: 54.7388, lon: 55.9721, name: 'Уфа' },
  'красноярск': { lat: 56.0153, lon: 92.8932, name: 'Красноярск' },
  'воронеж': { lat: 51.6615, lon: 39.2003, name: 'Воронеж' },
  'пермь': { lat: 58.0105, lon: 56.2502, name: 'Пермь' },
  'волгоград': { lat: 48.708, lon: 44.5133, name: 'Волгоград' },
  'краснодар': { lat: 45.0355, lon: 38.9753, name: 'Краснодар' },
  'сочи': { lat: 43.6028, lon: 39.7342, name: 'Сочи' },
  'владивосток': { lat: 43.1056, lon: 131.8735, name: 'Владивосток' },
  'иркутск': { lat: 52.2869, lon: 104.3050, name: 'Иркутск' },
  'тюмень': { lat: 57.1522, lon: 65.5272, name: 'Тюмень' },
  'калининград': { lat: 54.7104, lon: 20.4522, name: 'Калининград' },
  'мурманск': { lat: 68.9585, lon: 33.0827, name: 'Мурманск' },
  
  // Прибалтика
  'рига': { lat: 56.9496, lon: 24.1052, name: 'Рига' },
  'таллин': { lat: 59.4370, lon: 24.7536, name: 'Таллин' },
  'вильнюс': { lat: 54.6872, lon: 25.2797, name: 'Вильнюс' },
  
  // Беларусь
  'минск': { lat: 53.9006, lon: 27.5590, name: 'Минск' },
  'гомель': { lat: 52.4345, lon: 30.9754, name: 'Гомель' },
  'брест': { lat: 52.0976, lon: 23.7341, name: 'Брест' },
  
  // Украина
  'киев': { lat: 50.4501, lon: 30.5234, name: 'Киев' },
  'харьков': { lat: 49.9935, lon: 36.2304, name: 'Харьков' },
  'одесса': { lat: 46.4825, lon: 30.7233, name: 'Одесса' },
  'львов': { lat: 49.8397, lon: 24.0297, name: 'Львов' },
  
  // Казахстан
  'алматы': { lat: 43.2220, lon: 76.8512, name: 'Алматы' },
  'астана': { lat: 51.1694, lon: 71.4491, name: 'Астана' },
  'нур-султан': { lat: 51.1694, lon: 71.4491, name: 'Астана' },
  
  // Европа
  'амстердам': { lat: 52.3676, lon: 4.9041, name: 'Амстердам' },
  'берлин': { lat: 52.5200, lon: 13.4050, name: 'Берлин' },
  'париж': { lat: 48.8566, lon: 2.3522, name: 'Париж' },
  'лондон': { lat: 51.5074, lon: -0.1278, name: 'Лондон' },
  'мадрид': { lat: 40.4168, lon: -3.7038, name: 'Мадрид' },
  'рим': { lat: 41.9028, lon: 12.4964, name: 'Рим' },
  'вена': { lat: 48.2082, lon: 16.3738, name: 'Вена' },
  'прага': { lat: 50.0755, lon: 14.4378, name: 'Прага' },
  'варшава': { lat: 52.2297, lon: 21.0122, name: 'Варшава' },
  'стокгольм': { lat: 59.3293, lon: 18.0686, name: 'Стокгольм' },
  'хельсинки': { lat: 60.1699, lon: 24.9384, name: 'Хельсинки' },
  'осло': { lat: 59.9139, lon: 10.7522, name: 'Осло' },
  'копенгаген': { lat: 55.6761, lon: 12.5683, name: 'Копенгаген' },
  'барселона': { lat: 41.3851, lon: 2.1734, name: 'Барселона' },
  'милан': { lat: 45.4642, lon: 9.1900, name: 'Милан' },
  'мюнхен': { lat: 48.1351, lon: 11.5820, name: 'Мюнхен' },
  'цюрих': { lat: 47.3769, lon: 8.5417, name: 'Цюрих' },
  
  // Азия
  'токио': { lat: 35.6762, lon: 139.6503, name: 'Токио' },
  'пекин': { lat: 39.9042, lon: 116.4074, name: 'Пекин' },
  'шанхай': { lat: 31.2304, lon: 121.4737, name: 'Шанхай' },
  'сеул': { lat: 37.5665, lon: 126.9780, name: 'Сеул' },
  'бангкок': { lat: 13.7563, lon: 100.5018, name: 'Бангкок' },
  'сингапур': { lat: 1.3521, lon: 103.8198, name: 'Сингапур' },
  'дубай': { lat: 25.2048, lon: 55.2708, name: 'Дубай' },
  'стамбул': { lat: 41.0082, lon: 28.9784, name: 'Стамбул' },
  
  // Америка
  'нью-йорк': { lat: 40.7128, lon: -74.0060, name: 'Нью-Йорк' },
  'лос-анджелес': { lat: 34.0522, lon: -118.2437, name: 'Лос-Анджелес' },
  'торонто': { lat: 43.6532, lon: -79.3832, name: 'Торонто' },
  'сан-франциско': { lat: 37.7749, lon: -122.4194, name: 'Сан-Франциско' },
  'майами': { lat: 25.7617, lon: -80.1918, name: 'Майами' },
};

/**
 * Нормализация названия города (убираем падежные окончания)
 */
function normalizeCityName(name: string): string {
  let normalized = name.toLowerCase().trim();
  
  // Убираем типичные падежные окончания русского языка
  const endings = [
    'е', 'у', 'а', 'ы', 'и', 'ой', 'ей', 'ом', 'ем', 'ью',
    'ах', 'ях', 'ами', 'ями', 'ов', 'ев', 'ий'
  ];
  
  // Специальные случаи городов с изменяемыми окончаниями
  const specialCases: Record<string, string> = {
    'риге': 'рига',
    'ригу': 'рига',
    'ригой': 'рига',
    'москве': 'москва',
    'москву': 'москва',
    'москвой': 'москва',
    'праге': 'прага',
    'прагу': 'прага',
    'прагой': 'прага',
    'вене': 'вена',
    'вену': 'вена',
    'веной': 'вена',
    'варшаве': 'варшава',
    'варшаву': 'варшава',
    'одессе': 'одесса',
    'одессу': 'одесса',
    'самаре': 'самара',
    'самару': 'самара',
    'астане': 'астана',
    'астану': 'астана',
    'алматы': 'алматы',
    'париже': 'париж',
    'парижа': 'париж',
    'парижем': 'париж',
    'лондоне': 'лондон',
    'лондона': 'лондон',
    'лондоном': 'лондон',
    'берлине': 'берлин',
    'берлина': 'берлин',
    'берлином': 'берлин',
    'мадриде': 'мадрид',
    'мадрида': 'мадрид',
    'риме': 'рим',
    'рима': 'рим',
    'римом': 'рим',
    'токио': 'токио',
    'пекине': 'пекин',
    'пекина': 'пекин',
    'дубае': 'дубай',
    'дубая': 'дубай',
    'минске': 'минск',
    'минска': 'минск',
    'минском': 'минск',
    'киеве': 'киев',
    'киева': 'киев',
    'киевом': 'киев',
    'таллине': 'таллин',
    'таллина': 'таллин',
    'таллином': 'таллин',
    'вильнюсе': 'вильнюс',
    'вильнюса': 'вильнюс',
    'вильнюсом': 'вильнюс',
    'петербурге': 'санкт-петербург',
    'питере': 'санкт-петербург',
    'спб': 'санкт-петербург',
    'казани': 'казань',
    'казанью': 'казань',
    'сочи': 'сочи',
    'новосибирске': 'новосибирск',
    'екатеринбурге': 'екатеринбург',
    'красноярске': 'красноярск',
    'владивостоке': 'владивосток',
    'калининграде': 'калининград',
    'амстердаме': 'амстердам',
    'амстердама': 'амстердам',
    'стокгольме': 'стокгольм',
    'стокгольма': 'стокгольм',
    'хельсинки': 'хельсинки',
    'осло': 'осло',
    'копенгагене': 'копенгаген',
    'копенгагена': 'копенгаген',
    'барселоне': 'барселона',
    'барселону': 'барселона',
    'милане': 'милан',
    'милана': 'милан',
    'мюнхене': 'мюнхен',
    'мюнхена': 'мюнхен',
    'цюрихе': 'цюрих',
    'цюриха': 'цюрих',
    'шанхае': 'шанхай',
    'шанхая': 'шанхай',
    'сеуле': 'сеул',
    'сеула': 'сеул',
    'бангкоке': 'бангкок',
    'бангкока': 'бангкок',
    'сингапуре': 'сингапур',
    'сингапура': 'сингапур',
    'стамбуле': 'стамбул',
    'стамбула': 'стамбул',
  };
  
  if (specialCases[normalized]) {
    return specialCases[normalized];
  }
  
  return normalized;
}

/**
 * Найти координаты города по названию
 */
export function findCity(cityName: string): CityCoordinates | null {
  const normalized = normalizeCityName(cityName);
  
  // Прямой поиск
  if (CITIES[normalized]) {
    return CITIES[normalized];
  }
  
  // Поиск по частичному совпадению (для сложных случаев)
  for (const [key, coords] of Object.entries(CITIES)) {
    // Если ключ содержится в запросе или наоборот
    if (key.includes(normalized) || normalized.includes(key)) {
      return coords;
    }
    // Проверяем начало слова (минимум 3 символа)
    if (normalized.length >= 3 && key.startsWith(normalized.slice(0, 3))) {
      return coords;
    }
  }
  
  return null;
}

/**
 * Получить список всех доступных городов
 */
export function getAllCities(): string[] {
  const uniqueCities = new Set<string>();
  for (const coords of Object.values(CITIES)) {
    uniqueCities.add(coords.name);
  }
  return Array.from(uniqueCities).sort();
}

